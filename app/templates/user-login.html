{% extends "base.html" %}

{% block title %}
User Login
{% endblock %}

{% block main %}

<section class="bg-gray-50 dark:bg-gray-900">
  <div class="flex flex-col items-center justify-center px-6 py-8 mx-auto md:h-screen lg:py-0">
    <div
      class="w-full bg-white rounded-lg shadow-sm dark:border md:mt-0 sm:max-w-md xl:p-0 dark:bg-gray-800 dark:border-gray-700">
      {% if server_logo_url %}
      <div class="p-6 border-b border-gray-200 dark:border-gray-700">
        <img src="{{ server_logo_url }}" alt="{{ _(server_name) }}" class="w-full h-auto max-h-80 object-contain">
      </div>
      {% else %}
      <div class="flex items-center justify-center p-6 border-b border-gray-200 dark:border-gray-700">
        <span class="text-2xl font-semibold text-gray-900 dark:text-white">{{ _(server_name) }}</span>
      </div>
      {% endif %}
      <div class="p-6 space-y-4 md:space-y-6 sm:p-8">
        <h1 class="text-xl font-bold leading-tight tracking-tight text-gray-900 md:text-2xl dark:text-white">
          {{ _("Access Your Account") }}
        </h1>
        <p class="text-sm text-gray-600 dark:text-gray-400">
          {% if show_server_selection %}
            {{ _("Multiple servers found. Please select which server you want to access.") }}
          {% else %}
            {{ _("Enter your email to access your account and manage your subscriptions.") }}
          {% endif %}
        </p>
        {% if error %}
        <p class="mt-2 text-sm text-red-600 dark:text-red-500"><span class="font-medium">{{ error }}</span></p>
        {% endif %}
        
        {% if show_server_selection and servers %}
        <!-- Server Selection Form -->
        <div class="space-y-4">
          <h2 class="text-lg font-medium text-gray-900 dark:text-white">{{ _("Select Server") }}</h2>
          <form action="/user-login" method="POST" class="space-y-4">
            {% for server_info in servers %}
            <div class="flex items-center p-4 border border-gray-200 rounded-lg dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-800 cursor-pointer">
              <input type="radio" id="server_{{ server_info.server.id }}" name="selected_server_id" value="{{ server_info.server.id }}" 
                     class="w-4 h-4 text-primary bg-gray-100 border-gray-300 focus:ring-primary dark:focus:ring-primary dark:ring-offset-gray-800 focus:ring-2 dark:bg-gray-700 dark:border-gray-600" required>
              <label for="server_{{ server_info.server.id }}" class="ml-3 flex-1 cursor-pointer">
                <div class="text-sm font-medium text-gray-900 dark:text-white">{{ server_info.server.name }}</div>
                <div class="text-xs text-gray-500 dark:text-gray-400">
                  {{ server_info.server.server_type|title }} Server
                  {% if server_info.user.email %}
                    ({{ server_info.user.email }})
                  {% else %}
                    ({{ server_info.user.username }})
                  {% endif %}
                </div>
              </label>
            </div>
            {% endfor %}
            
            <input type="hidden" name="email" value="{{ email }}">
            <input type="hidden" name="password" value="{{ password }}">
            <input type="hidden" name="login_type" value="email">
            
            <button type="submit" class="w-full text-white bg-primary hover:bg-primary_hover focus:ring-4 focus:outline-hidden focus:ring-amber-300 font-medium rounded-lg text-sm px-5 py-2.5 text-center dark:bg-primary dark:hover:bg-primary_hover dark:focus:ring-primary_hover">
              {{ _("Continue to Selected Server") }}
            </button>
          </form>
        </div>
        {% else %}
        
        <!-- Simplified Email Login Form -->
        <div class="space-y-4">
          <form id="email-login-form" class="space-y-4 md:space-y-6" action="/user-login" method="POST">
            <div>
              <label for="email" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">{{ _("Email Address") }}</label>
              <input type="email" name="email" id="email"
                class="bg-gray-50 border border-gray-300 text-gray-900 sm:text-sm rounded-lg focus:ring-primary focus:border-primary block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-blue-500 dark:focus:border-blue-500"
                placeholder="{{ _('Enter your email address') }}" required="">
            </div>
            <div id="password-field" style="display: none;">
              <label for="password" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">{{ _("Password") }}</label>
              <input type="password" name="password" id="password"
                class="bg-gray-50 border border-gray-300 text-gray-900 sm:text-sm rounded-lg focus:ring-primary focus:border-primary block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-blue-500 dark:focus:border-blue-500"
                placeholder="••••••••">
            </div>
            <div id="plex-auth-section" style="display: none;">
              <p class="text-sm text-blue-600 dark:text-blue-400 mb-3">{{ _("This account uses Plex authentication. Click below to sign in with Plex.") }}</p>
              <button type="button" id="plex-oauth-btn" onclick="oauth(); return false;"
                class="w-full text-white bg-primary hover:bg-primary_hover focus:ring-4 focus:outline-hidden focus:ring-amber-300 font-medium rounded-lg text-sm px-5 py-2.5 text-center dark:bg-primary dark:hover:bg-primary_hover dark:focus:ring-primary_hover">
                {{ _("Sign in with Plex") }}
              </button>
            </div>
            <button type="submit" id="continue-btn"
              class="w-full text-white bg-primary hover:bg-primary_hover focus:ring-4 focus:outline-hidden focus:ring-amber-300 font-medium rounded-lg text-sm px-5 py-2.5 text-center dark:bg-primary dark:hover:bg-primary_hover dark:focus:ring-primary_hover">
              {{ _("Continue") }}
            </button>
            <input type="hidden" name="login_type" value="email">
            <input type="hidden" name="token" id="token" value="">
          </form>
        </div>
        {% endif %}
        
        <div class="text-center">
          <p class="text-sm text-gray-600 dark:text-gray-400">
            {{ _("Don't have an account?") }}
            <a href="mailto:{{ admin_email or 'admin' }}" class="font-medium text-primary hover:underline dark:text-primary">
              {{ _("Contact admin") }}
            </a>
          </p>
        </div>
        
        <div class="text-center">
          <p class="text-sm text-gray-600 dark:text-gray-400">
            {{ _("Administrator?") }}
            <a href="/login" class="font-medium text-primary hover:underline dark:text-primary">
              {{ _("Admin Login") }}
            </a>
          </p>
        </div>
      </div>
    </div>
  </div>
</section>

<script src="https://unpkg.com/bowser@2.7.0/es5.js"></script>
<script>
// Auto-detect server type and authentication method based on email input
async function checkServerType() {
    const emailInput = document.getElementById('email');
    const passwordField = document.getElementById('password-field');
    const plexAuthSection = document.getElementById('plex-auth-section');
    const continueBtn = document.getElementById('continue-btn');
    
    if (!emailInput) return;
    
    emailInput.addEventListener('input', async function() {
        const email = this.value.trim();
        if (email.length > 2 && email.includes('@')) {
            try {
                // Check what authentication method this email requires
                const response = await fetch('/api/detect-auth-method', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ email: email })
                });
                
                const result = await response.json();
                
                // Reset all sections
                passwordField.style.display = 'none';
                plexAuthSection.style.display = 'none';
                continueBtn.style.display = 'block';
                document.getElementById('password').required = false;
                
                if (result.auth_method === 'plex') {
                    // Show Plex OAuth section, hide password and continue button
                    plexAuthSection.style.display = 'block';
                    continueBtn.style.display = 'none';
                } else if (result.auth_method === 'password') {
                    // Show password field for Jellyfin/Emby/Audiobookshelf
                    passwordField.style.display = 'block';
                    document.getElementById('password').required = true;
                }
                // If auth_method is 'none' or not found, keep form simple with just continue button
                
            } catch (error) {
                console.error('Auth method detection failed:', error);
                // Default to showing password field if detection fails
                passwordField.style.display = 'block';
                plexAuthSection.style.display = 'none';
                continueBtn.style.display = 'block';
                document.getElementById('password').required = true;
            }
        } else {
            // Reset to default state
            passwordField.style.display = 'none';
            plexAuthSection.style.display = 'none';
            continueBtn.style.display = 'block';
            document.getElementById('password').required = false;
        }
    });
}

// Plex OAuth functionality
let nanoid = (t = 21) => crypto.getRandomValues(new Uint8Array(t)).reduce(((t, e) => t += (e &= 63) < 36 ? e.toString(36) : e < 62 ? (e - 26).toString(36).toUpperCase() : e > 62 ? "-" : "_"), "");

async function oauth() {
    let popup = window.open("", "Plex", 'width=600, height=700, toolbar=no, menubar=no');
    const browser = window.bowser.getParser(window.navigator.userAgent);
    const plexHeaders = {
        Accept: 'application/json',
        'X-Plex-Product': 'Wizarr',
        'X-Plex-Version': 'Plex OAuth',
        'X-Plex-Client-Identifier': nanoid(),
        'X-Plex-Model': 'Plex OAuth',
        'X-Plex-Platform': browser.getBrowserName(),
        'X-Plex-Platform-Version': browser.getBrowserVersion(),
        'X-Plex-Device': browser.getOSName(),
        'X-Plex-Device-Name': `${browser.getBrowserName()} (Wizarr)`,
        'X-Plex-Device-Screen-Resolution': `${window.screen.width}x${window.screen.height}`,
    }
    
    const pin = await fetch("https://plex.tv/api/v2/pins?strong=true", {
        method: "POST",
        headers: plexHeaders
    }).then(r => r.json())

    const params = new URLSearchParams({
        clientID: plexHeaders['X-Plex-Client-Identifier'],
        'context[device][product]': plexHeaders['X-Plex-Product'],
        'context[device][version]': plexHeaders['X-Plex-Version'],
        'context[device][platform]': plexHeaders['X-Plex-Platform'],
        'context[device][platformVersion]': plexHeaders['X-Plex-Platform-Version'],
        'context[device][device]': plexHeaders['X-Plex-Device'],
        'context[device][deviceName]': plexHeaders['X-Plex-Device-Name'],
        'context[device][model]': plexHeaders['X-Plex-Model'],
        'context[device][screenResolution]': plexHeaders['X-Plex-Device-Screen-Resolution'],
        'context[device][layout]': 'desktop',
        code: pin.code
    });

    popup.location.href = `https://app.plex.tv/auth/#!?${params}`;

    const authToken = await new Promise((resolve, reject) => {
        const interval = setInterval(async () => {
            if (popup.closed) return location.reload();
            const resp = await fetch(`https://plex.tv/api/v2/pins/${pin.id}`, {
                headers: plexHeaders
            }).then(r => r.json())

            if (resp?.errors?.length) return location.reload();
            if (resp?.authToken) {
                clearInterval(interval)
                resolve(resp.authToken);
                return;
            }
        }, 1000)
    });
    
    document.querySelector("#token").value = authToken;
    document.querySelector("#email-login-form").submit();
}

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    checkServerType();
});
</script>

<style>
.login-tab {
    color: #6b7280;
    background-color: transparent;
}

.login-tab.active {
    color: #1f2937;
    background-color: #ffffff;
    box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
}

.dark .login-tab {
    color: #9ca3af;
}

.dark .login-tab.active {
    color: #ffffff;
    background-color: #374151;
}
</style>

{% endblock %}